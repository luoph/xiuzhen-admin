<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.jeecg.modules.player.mapper.GamePlayerItemLogMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="org.jeecg.modules.player.entity.GamePlayerItemLog">
        <id column="id" property="id"/>
        <result column="player_id" property="playerId"/>
        <result column="item_id" property="itemId"/>
        <result column="num" property="num"/>
        <result column="way" property="way"/>
        <result column="type" property="type"/>
        <result column="before_num" property="beforeNum"/>
        <result column="after_num" property="afterNum"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
        <result column="sync_time" property="syncTime"/>
        <result column="item_num" property="itemNum"/>
        <result column="add_item_num" property="addItemNum"/>
        <result column="consume_item_num" property="consumeItemNum"/>
        <result column="way_name" property="wayName"/>
        <result column="player_num" property="playerNum"/>
        <result column="item_count" property="itemCount"/>
        <result column="item_num_rate" property="itemNumRate"/>
        <result column="item_num_sum" property="itemNumSum"/>

        <association property="registerInfo" javaType="org.jeecg.modules.player.entity.GameRegisterInfo">
            <id column="pri_id" property="id"/>
            <result column="pri_name" property="name"/>
        </association>

    </resultMap>

    <select id="queryCurrencyPayIncomeList" resultMap="BaseResultMap">
        SELECT
        sync_time,
        SUM(num) add_item_num
        FROM game_player_item_log
        WHERE
        item_id = #{itemId}
        AND type = #{type}
        AND sync_time >= #{rangeDateBeginTime} AND sync_time &lt;= #{rangeDateEndTime}
        <if test="serverId != 0">
            AND server_id = #{serverId}
        </if>
        GROUP BY sync_time
        ORDER BY add_item_num DESC
    </select>

    <select id="getBySyncTime" resultType="java.math.BigDecimal">
        SELECT
        SUM(num) consume_item_num
        FROM game_player_item_log
        WHERE
        item_id = #{itemId}
        AND type = #{type}
        AND sync_time = #{syncTime}
        <if test="serverId != 0">
            AND server_id = #{serverId}
        </if>
    </select>

    <select id="queryWayDistributeList" resultMap="BaseResultMap">
        SELECT
        way,
        SUM(num) item_num,
        COUNT(DISTINCT(player_id)) player_num
        FROM
        game_player_item_log
        WHERE
        item_id = #{itemId}
        AND type = #{type}
        AND sync_time >= #{rangeDateBeginTime} AND sync_time &lt;= #{rangeDateEndTime}
        <if test="serverId != 0">
            AND server_id = #{serverId}
        </if>
        GROUP BY way
        ORDER BY item_num DESC
    </select>

    <select id="queryItemSum" resultType="java.math.BigDecimal">
        SELECT
        SUM(num) item_num_sum
        FROM
        game_player_item_log
        WHERE
        type = #{type}
        AND sync_time >= #{rangeDateBeginTime} AND sync_time &lt;= #{rangeDateEndTime}
        <if test="serverId != 0">
            AND server_id = #{serverId}
        </if>
    </select>

    <select id="queryItemCount" resultType="java.math.BigDecimal">
        SELECT
        COUNT(way) item_count
        FROM
        game_player_item_log
        WHERE
        item_id = #{itemId}
        AND type = #{type}
        AND sync_time >= #{rangeDateBeginTime} AND sync_time &lt;= #{rangeDateEndTime}
        <if test="serverId != 0">
            AND server_id = #{serverId}
        </if>
    </select>

    <select id="queryItemBillList" resultMap="BaseResultMap">
        SELECT
        pil.player_id,
        pil.item_id,
        pil.way,
        pil.type,
        pil.before_num,
        pil.num,
        pil.after_num,
        pil.sync_time,
        pri.name pri_name
        FROM
        game_player_item_log pil
        LEFT JOIN game_register_info pri ON pil.player_id = pri.player_id
        <where>
            <if test="playerId !=0 ">
                AND pil.player_id = #{playerId}
            </if>
            <if test="itemId !=0 ">
                AND pil.item_id = #{itemId}
            </if>
            <if test="type !=0 ">
                AND pil.type = #{type}
            </if>
            <if test="way !=0 ">
                AND pil.way = #{way}
            </if>
            <if test="rangeDateBeginTime !=null ">
                AND pil.sync_time >= #{rangeDateBeginTime}
            </if>
            <if test="rangeDateEndTime !=null ">
                AND pil.sync_time &lt;= #{rangeDateEndTime}
            </if>
            ORDER BY pil.sync_time DESC
        </where>

    </select>
</mapper>